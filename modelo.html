<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo 3D Interactivo - TeddyWeb</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; }
        #canvas-container { width: 100%; height: 100vh; display: block; }
        
        #instructions {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            color: white; font-family: 'Segoe UI', sans-serif; background: rgba(0, 0, 0, 0.6);
            padding: 12px 25px; border-radius: 30px; pointer-events: none; user-select: none;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">TeddyWeb</div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-item">Portada</a></li>
            <li><a href="referencias.html" class="nav-item">Referencias</a></li>
            <li><a href="objetivo.html" class="nav-item">Objetivo</a></li>
            <li><a href="modelo.html" class="nav-item active">Modelado 3D</a></li>
        </ul>
    </nav>

    <div id="canvas-container"></div>
    <div id="instructions">üñ±Ô∏è Clic en el <b>Robot</b> (M√∫sica) o en la <b>Laptop</b> (Video)</div>

    <!-- === RECURSOS OCULTOS (Video para la textura) === -->
    <!-- Pon aqu√≠ tu video real. 'playsinline' es vital para m√≥viles -->
    <video id="videoLaptop" loop playsinline style="display:none" crossorigin="anonymous">
        <source src="assets/Imagenes_y_videos/laptop/VideoPantalla.mp4" type="video/mp4">
    </video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- 1. ESCENA B√ÅSICA ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x202020);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.outputColorSpace = THREE.SRGBColorSpace; // Colores correctos
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 1, 0);

        // Iluminaci√≥n
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);


        // --- 2. PREPARAR EL VIDEO (TEXTURA) ---
        const videoElement = document.getElementById('videoLaptop');
        const videoTexture = new THREE.VideoTexture(videoElement);
        videoTexture.flipY = false; // Importante para GLTF
        videoTexture.colorSpace = THREE.SRGBColorSpace;
        
        // Material especial que brilla con el video
        const pantallaMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });


        // --- 3. PREPARAR EL AUDIO ---
        const listener = new THREE.AudioListener();
        camera.add(listener);
        const sound = new THREE.Audio(listener);
        const audioLoader = new THREE.AudioLoader();
        
        // URL de prueba (C√°mbiala por 'assets/sonidos/musica.mp3')
        const musicUrl = 'assets/Imagenes_y_videos/sonido/‚ÄúGolden‚Äù Official Lyric Video KPop Demon Hunters Sony Animation.mp3'; 
        
        audioLoader.load(musicUrl, function(buffer) {
            sound.setBuffer(buffer);
            sound.setLoop(true);
            sound.setVolume(0.5);
        });


        // --- 4. CARGAR MODELO Y BUSCAR OBJETOS ---
        const loader = new GLTFLoader();
        let loadedModel;

        // ¬°ATENCI√ìN! Aqu√≠ debes poner el nombre de tu archivo .glb que contiene TODO (robot, laptop, mesa)
        loader.load('assets/archivo_blender/setup_gamer_25_3.glb', function (gltf) {
            loadedModel = gltf.scene;
            
            // RECORRER EL MODELO PARA ENCONTRAR LAS COSAS
            loadedModel.traverse((child) => {
                if (child.isMesh) {
                    // A. Configurar la Pantalla de la Laptop
                    // Aseg√∫rate de que en Blender el material se llame 'Material_PantallaLaptop'
                    // o el objeto se llame 'Objeto_PantallaLaptop'
                    if (child.name.includes('Laptop') || child.material.name.includes('Pantalla')) {
                        child.material = pantallaMaterial; // Le pegamos el video
                        child.name = "Interactuable_Laptop"; // Le ponemos una etiqueta para el clic
                    }

                    // B. Configurar el Robot
                    if (child.name.includes('Robot') || child.name.includes('Cubo')) {
                        child.name = "Interactuable_Robot"; // Etiqueta para el clic
                    }
                }
            });

            scene.add(loadedModel);

        }, undefined, function (error) {
            console.error('Error cargando modelo:', error);
            // Cubo de emergencia por si falla la carga
            const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:'red'}));
            cube.name = "Interactuable_Robot"; 
            scene.add(cube);
        });


        // --- 5. SISTEMA DE CLICS (INTERACTIVIDAD) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            // 1. Calcular posici√≥n del mouse
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // 2. Disparar rayo
            raycaster.setFromCamera(mouse, camera);
            
            // 3. Ver qu√© tocamos (intersectObjects busca en toda la escena)
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                // Obtenemos el primer objeto tocado
                // A veces tocamos una parte interna, as√≠ que buscamos el nombre hacia arriba si es necesario
                const objetoTocado = intersects[0].object;
                console.log("Tocaste:", objetoTocado.name); // Para depurar en consola (F12)

                // --- ACCI√ìN: ROBOT (SONIDO) ---
                if (objetoTocado.name.includes('Robot')) {
                    toggleAudio();
                }

                // --- ACCI√ìN: LAPTOP (VIDEO) ---
                if (objetoTocado.name.includes('Laptop')) {
                    toggleVideo();
                }
            }
        });

        // Funci√≥n Sonido
        function toggleAudio() {
            if (listener.context.state === 'suspended') listener.context.resume();
            
            if (sound.isPlaying) {
                sound.pause();
                console.log("Audio Pausado");
            } else {
                sound.play();
                console.log("Audio Reproduciendo");
            }
        }

        // Funci√≥n Video
        function toggleVideo() {
            if (videoElement.paused) {
                videoElement.play();
                console.log("Video Play");
            } else {
                videoElement.pause();
                console.log("Video Pause");
            }
        }


        // --- 6. BUCLE DE ANIMACI√ìN ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Responsive
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>