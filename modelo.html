<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo 3D Interactivo - TeddyWeb</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; }
        #canvas-container { width: 100%; height: 100vh; display: block; }
        
        #instructions {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            color: white; font-family: 'Segoe UI', sans-serif; background: rgba(0, 0, 0, 0.6);
            padding: 12px 25px; border-radius: 30px; pointer-events: none; user-select: none;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">TeddyWeb</div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-item">Portada</a></li>
            <li><a href="referencias.html" class="nav-item">Referencias</a></li>
            <li><a href="objetivo.html" class="nav-item">Objetivo</a></li>
            <li><a href="modelo.html" class="nav-item active">Modelado 3D</a></li>
        </ul>
    </nav>

    <div id="canvas-container"></div>
    <div id="instructions">
        üñ±Ô∏è Clic en: <b>Robot</b> (M√∫sica) | <b>Laptop</b> (Video) | <b>Tablet</b> (Fondo)
    </div>

    <video id="videoLaptop" loop playsinline style="display:none" crossorigin="anonymous">
        <source src="assets/Imagenes_y_videos/laptop/animacion.mp4" type="video/mp4">
    </video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- ESCENA ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x202020);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 1, 0);

        // --- RELOJ PARA ANIMACIONES ---
        const clock = new THREE.Clock();
        let mixer; 

        // --- LUCES ---
        scene.add(new THREE.AmbientLight(0xffffff, 1.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // ==========================================
        // --- MATERIALES INTERACTIVOS (PANTALLAS) ---
        // ==========================================

        // 1. MATERIAL APAGADO (Para Laptop y Tablet)
        const pantallaOffMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });

        // 2. CONFIGURACI√ìN LAPTOP (VIDEO)
        const videoElement = document.getElementById('videoLaptop');
        const videoTexture = new THREE.VideoTexture(videoElement);
        videoTexture.flipY = false;
        videoTexture.colorSpace = THREE.SRGBColorSpace;
        const pantallaLaptopOnMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });
        
        let pantallaLaptopMesh = null;
        let laptopEncendida = false;

        // 3. CONFIGURACI√ìN TABLET (IMAGEN EST√ÅTICA) - ¬°NUEVO!
        const textureLoader = new THREE.TextureLoader();
        // colocar imagen aqui
        const tabletTexture = textureLoader.load('assets/Imagenes_y_videos/Tablet/lunaFondo.jpg'); 
        tabletTexture.flipY = false; // Importante para modelos GLTF
        tabletTexture.colorSpace = THREE.SRGBColorSpace;
        const pantallaTabletOnMaterial = new THREE.MeshBasicMaterial({ map: tabletTexture });

        let pantallaTabletMesh = null;
        let tabletEncendida = false;


        // --- AUDIO ---
        const listener = new THREE.AudioListener();
        camera.add(listener);
        const sound = new THREE.Audio(listener);
        const audioLoader = new THREE.AudioLoader();

        audioLoader.load('assets/Imagenes_y_videos/sonido/musica.mp3', function(buffer) {
            sound.setBuffer(buffer);
            sound.setLoop(true);
            sound.setVolume(0.5);
        });

        // --- CARGAR MODELO ---
        const loader = new GLTFLoader();
        let loadedModel;

        loader.load('assets/archivo_blender/setup_gamer_25_3.glb', function(gltf) {
            loadedModel = gltf.scene;

            // ANIMACIONES
            if (gltf.animations && gltf.animations.length > 0) {
                mixer = new THREE.AnimationMixer(loadedModel);
                gltf.animations.forEach((clip) => {
                    mixer.clipAction(clip).play();
                });
            }

            loadedModel.traverse((child) => {
                if (child.isMesh) {

                    // A. DETECTAR LAPTOP
                    if (child.name.includes("Laptop") || child.material.name.includes("Pantalla")) {
                        pantallaLaptopMesh = child;
                        child.material = pantallaOffMaterial; 
                        child.name = "Interactuable_Laptop";
                    }

                    // B. DETECTAR TABLET (Seg√∫n tu imagen de Blender: PantallaTablet)
                    if (child.name === "PantallaTablet") {
                        pantallaTabletMesh = child;
                        child.material = pantallaOffMaterial; // Inicia apagada (negra)
                        child.name = "Interactuable_Tablet"; // Nombre clave para el click
                    }

                    // C. DETECTAR ROBOT
                    if (child.name.includes("Robot") || child.name.includes("Cubo")) {
                        child.name = "Interactuable_Robot";
                    }
                }
            });

            scene.add(loadedModel);
        });

        // --- CLICK (RAYCASTER) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                const obj = intersects[0].object;

                // L√≥gica de interacci√≥n seg√∫n el nombre
                if (obj.name.includes('Robot')) toggleAudio();
                if (obj.name.includes('Laptop')) toggleVideo();
                if (obj.name.includes('Tablet')) toggleTablet(); // ¬°Nuevo Click!
            }
        });

        // --- FUNCIONES DE INTERACCI√ìN ---

        function toggleAudio() {
            if (listener.context.state === "suspended") listener.context.resume();
            if (sound.isPlaying) sound.pause();
            else sound.play();
        }

        function toggleVideo() {
            if (!pantallaLaptopMesh) return;
            laptopEncendida = !laptopEncendida;

            if (laptopEncendida) {
                pantallaLaptopMesh.material = pantallaLaptopOnMaterial;
                videoElement.play();
            } else {
                pantallaLaptopMesh.material = pantallaOffMaterial;
                videoElement.pause();
            }
        }

        function toggleTablet() {
            if (!pantallaTabletMesh) return;
            tabletEncendida = !tabletEncendida;

            if (tabletEncendida) {
                pantallaTabletMesh.material = pantallaTabletOnMaterial; // Muestra la imagen
            } else {
                pantallaTabletMesh.material = pantallaOffMaterial; // Se pone negra
            }
        }

        // --- LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);

            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // --- RESPONSIVE ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>